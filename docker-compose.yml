# ---------------------------------------------------------------------------
# Docker Compose Configuration for Referee-Mediated Discourse
# ---------------------------------------------------------------------------
# Copyright (c) 2026 Cheongwon Choi <ccw1914@naver.com>
# Licensed under CC BY-NC 4.0
#   - Personal use allowed. Commercial use prohibited.
#   - Attribution required.
# ---------------------------------------------------------------------------

version: '3.8'

services:
  # ── 원자력 vs 재생에너지 토론 (4명 토론자) ─────────────────────────────
  referee-debate:
    build: .
    image: referee-mediated-discourse:latest
    container_name: referee-debate-experiment
    restart: on-failure
    env_file:
      - .env  # [FIX-MEDIUM-P2] environment 중복 제거 (Grok 제안)
    volumes:
      # 로컬 outputs/ 폴더가 없으면 Docker가 root로 자동 생성하여
      # 컨테이너 내부 appuser가 쓰기 못합니다.
      # entrypoint.sh가 컨테이너 시작 시 chown으로 재설정하지만,
      # 호스트 폴더를 사전 생성하는 것이 안전합니다.
      #   → mkdir -p outputs  (빌드 전 실행 권장)
      - ./outputs:/app/outputs
    # [FIX-CRITICAL-3] Dockerfile의 ENTRYPOINT는 entrypoint.sh만 지정
    # 모든 실험 파라미터는 command에서 전달
    command: ["--debaters", "4", "--experiment", "nuclear_energy", "--seed", "42"]

  # ── 철학적 토론: 선 vs 악 ───────────────────────────────────────────────
  philosophy-debate:
    build: .
    image: referee-mediated-discourse:latest
    container_name: philosophy-debate-experiment
    restart: on-failure
    env_file:
      - .env  # [FIX-MEDIUM-P2] environment 중복 제거 (Grok 제안)
    volumes:
      - ./outputs:/app/outputs
    command: ["--debaters", "4", "--experiment", "good_vs_evil", "--seed", "42"]
    profiles:
      - philosophy

  # ── 6명 토론자 실험 ─────────────────────────────────────────────────────
  six-debaters:
    build: .
    image: referee-mediated-discourse:latest
    container_name: six-debaters-experiment
    restart: on-failure
    env_file:
      - .env  # [FIX-MEDIUM-P2] environment 중복 제거 (Grok 제안)
    volumes:
      - ./outputs:/app/outputs
    # 6명 토론자는 command에 --debaters 6만 지정하면 됨
    command: ["--debaters", "6", "--experiment", "nuclear_energy", "--seed", "99"]
    profiles:
      - extended
