version: '3.8'

services:
  # ── 원자력 vs 재생에너지 토론 ──────────────────────────────────────
  referee-debate:
    build: .
    image: referee-mediated-discourse:latest
    container_name: referee-debate-experiment
    restart: on-failure
    env_file:
      - .env
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    volumes:
      # 로컬 outputs/ 폴더가 없으면 Docker가 root로 자동 생성하여
      # 컨테이너 내부 appuser가 쓰기 못합니다.
      # entrypoint.sh 대신 호스트측 폴더를 사전 생성하거나,
      # 아래 command에 --output-dir를 컨테이너 내부 경로로 지정합니다.
      - ./outputs:/app/outputs
    # ENTRYPOINT에 --debaters 4가 포함되어 있으므로
    # command에는 --experiment와 --seed만 지정하면 됩니다.
    command: ["--experiment", "nuclear_energy", "--seed", "42"]

  # ── 철학적 토론: 선 vs 악 ─────────────────────────────────────────
  philosophy-debate:
    build: .
    image: referee-mediated-discourse:latest
    container_name: philosophy-debate-experiment
    restart: on-failure
    env_file:
      - .env
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    volumes:
      - ./outputs:/app/outputs
    command: ["--experiment", "good_vs_evil", "--seed", "42"]
    profiles:
      - philosophy

  # ── 6명 토론자 실험 (확장 예시) ────────────────────────────────────
  # ENTRYPOINT의 --debaters 4를 덮어쓰려면 entrypoint를 직접 지정해야 합니다.
  six-debaters:
    build: .
    image: referee-mediated-discourse:latest
    container_name: six-debaters-experiment
    restart: on-failure
    env_file:
      - .env
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    volumes:
      - ./outputs:/app/outputs
    entrypoint: ["python", "referee_mediated_discourse.py", "--debaters", "6"]
    command: ["--experiment", "nuclear_energy", "--seed", "99"]
    profiles:
      - extended
